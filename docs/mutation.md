# Mutation 演算子まとめ

> `src/genalgo/mutation.py` に実装されている **ガウス変異 (Gaussian Mutation)** と
> ヘルパー関数 `_clip` を解説します。実数遺伝子 GA の「局所探索」を担う部分です。

---

## 目次

1. [gaussian](#gaussian)
2. [\_clip](#clip)
3. パラメータの調整指針
4. よくある質問

---

<a name="gaussian"></a>

## 1. `gaussian`

```python
child = gaussian(x, sigma=0.1, prob=0.2, bounds=(-5, 5), rng=rng)
```

| 引数       | 型             | 既定値    | 説明                                               |
| -------- | ------------- | ------ | ------------------------------------------------ |
| `x`      | ndarray       | —      | 親個体 (1-D)。コピーして子を作るので元は変化しない                     |
| `sigma`  | float         | 0.1    | ノイズの標準偏差 σ (遺伝子スケールで設定)                          |
| `prob`   | float         | 0.1    | 遺伝子 1 つあたりの変異確率 p                                |
| `bounds` | tuple or list | `None` | `(lo, hi)` または `[(lo0,hi0)...]`。超えたら `_clip` で戻す |
| `rng`    | Generator     | 新規     | 乱数生成器 (再現用に渡せる)                                  |

### アルゴリズム

1. 子 = `x.copy()` で複製
2. マスク `mask = rng.random(size) < prob` で変異遺伝子を決定
3. `child[mask] += rng.normal(0, sigma, size=mask.sum())`
4. `_clip(child, bounds)` で範囲外を抑制

数式で書くと

$$
 x_i' = \begin{cases}
   x_i + \mathcal N(0,\sigma^2) & \text{with probability } p\\
   x_i                          & \text{otherwise}
 \end{cases}
$$

### 効果

* σ を大きく → 大ジャンプで局所最適を脱出
* σ を小さく → 微調整で精度アップ
* `prob` を 1.0 にすると **すべての遺伝子** にノイズを入れる（1 次元ではこれを推奨）

---

<a name="clip"></a>

## 2. `_clip`

内部関数：

```python
def _clip(x, bounds):
    return np.clip(x, lo, hi)
```

* `bounds` が `None` なら何もしない
* タプル 1 つなら全遺伝子共通、リストなら遺伝子ごと

使う理由：物理量には **実在範囲** がある場合が多い
（例）ばね定数 `k > 0`、確率 `0 ≤ p ≤ 1` など。

---

## 3. パラメータ調整のヒント

| ステージ  | σ             | p   | 備考      |
| ----- | ------------- | --- | ------- |
| 初期粗探索 | 0.2〜0.3 × 範囲幅 | 0.5 | 大域探索優先  |
| 中盤探索  | 0.1           | 0.3 | 交叉と併用   |
| 収束直前  | 0.02          | 1.0 | きめ細かい詰め |

### 自己適応 (Advanced)

研究用には `σ` 自体を遺伝子の一部にして進化させる「自己適応 GA」もあります。
本チュートリアルでは実装していませんが、`mutation.py` に追加するのは容易です。

---

## 4. よくある質問

| Q              | A                                                           |
| -------------- | ----------------------------------------------------------- |
| σ を大きくしたら収束しない | 序盤は大、途中から小さく（アニーリング）。`mutation_sigma` を世代に応じて変える関数を渡すと良いです。 |
| 変異が弱くて局所にハマる   | `prob` を上げる、`sigma` を大きくする、交叉率を上げる、のいずれかで多様性を確保。            |
| 離散変数でも使える？     | ガウス変異は連続専用。バイナリならビットフリップ、整数なら ±1 ランダムウォークが向きます。             |

---

### 参考文献

* Rechenberg, I. **Evolutionsstrategie.** (1973) — 進化戦略でのガウス変異。
